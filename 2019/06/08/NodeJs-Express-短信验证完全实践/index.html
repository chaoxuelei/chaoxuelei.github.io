<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Joshua"><title>NodeJs + Express 短信验证完全实践 · Joshua-blog</title><meta name="description" content="最近在深入学习nodejs+express+mysql的全栈开发，我知道现在mysql、express是老旧的，但是个人感觉还是挺成熟的，而且比较熟悉，先学学看，后面再看看kao、MongoDB，下面就来说说我用nodejs和腾讯云的短信sdk开发的验证码服务，大神嘴下留情啊~。

需求需要实现使用"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="main"><div class="page-top animated fadeInDown"><div class="main"><div class="sidebar animated fadeInDown"><div class="logo-title"><a href="/"><img src="/images/logo@2x.png" style="height:40px;"></a></div></div><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="cont-right"><div class="post-title"><h3><h2 style="text-align: center;">NodeJs + Express 短信验证完全实践</h2></h3></div><div class="post-content"><blockquote>
<p>最近在深入学习nodejs+express+mysql的全栈开发，我知道现在mysql、express是老旧的，但是个人感觉还是挺成熟的，而且比较熟悉，先学学看，后面再看看kao、MongoDB，下面就来说说我用nodejs和腾讯云的短信sdk开发的验证码服务，大神嘴下留情啊~。</p>
</blockquote>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>需要实现使用nodejs发送验证码的需求，同一手机号180s只能请求一次。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>按步骤走（分析需求的已经形成习惯了^ _ ^）</p>
<ul>
<li>判断手机号码是否在180s内发过，如果发过告知180s内只能发一次，* 否则重新计算验证码。</li>
<li>如果手机号码从没发过，计算验证码。</li>
<li>存储验证码。</li>
<li>发送验证码。</li>
<li>验证注册数据中手机号和验证码是否都一致。<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h4 id="发送验证码"><a href="#发送验证码" class="headerlink" title="发送验证码"></a>发送验证码</h4>先看流程图：<br><img src="https://i.loli.net/2018/08/24/5b7f6651887c6.png" alt></li>
</ul>
<p>使用了express的session包，安装和使用在下面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express-session --save</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app = express();</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">        secret: <span class="string">'610481'</span>, </span><br><span class="line">        resave: <span class="literal">false</span>, </span><br><span class="line">        saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">        cookie: &#123;</span><br><span class="line">            maxAge: <span class="number">1000</span>*<span class="number">60</span>*<span class="number">30</span></span><br><span class="line">        &#125;,</span><br><span class="line">        rolling:<span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上代码：只是示例啊</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">selectPhone:<span class="function">(<span class="params">req,res,next</span>) =&gt;</span> &#123; <span class="comment">//从路由跳到这</span></span><br><span class="line">       <span class="keyword">let</span> phone = req.body.phone, <span class="comment">//获取post参数“话号码”</span></span><br><span class="line">           romStr; <span class="comment">//声明随机变量</span></span><br><span class="line">       <span class="keyword">if</span>(req.session[phone])&#123; <span class="comment">//判断session里面是否存在phone(电话号码，为变量)这个key</span></span><br><span class="line">           <span class="keyword">if</span>((<span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>()) - req.session[phone][<span class="number">1</span>])/<span class="number">1000</span> &gt; <span class="number">180</span>)&#123;</span><br><span class="line">               romStr = RndNum(<span class="number">4</span>);</span><br><span class="line">               req.session[phone] = [romStr,<span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>())];<span class="comment">//存储session</span></span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               res.json(&#123;<span class="attr">msg</span>:<span class="string">"180秒内只能发一条！"</span>&#125;)</span><br><span class="line">               <span class="keyword">return</span> <span class="comment">//res end以后记得return 否则就报错了</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           romStr = RndNum(<span class="number">4</span>);</span><br><span class="line">           req.session[phone] = [romStr,<span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>())]; </span><br><span class="line">       &#125;;</span><br><span class="line">       pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123; </span><br><span class="line">           <span class="comment">// 建立连接</span></span><br><span class="line">           connection.query(userSQL.selectPhone, phone, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">               <span class="comment">//查询手机号是否被注册，judageRes是一个自己写的方法，用于处理数据库查出来的数据的。处理完之后，返回到回调。</span></span><br><span class="line">               common.judgeRes(result,<span class="string">'query'</span>,err,res,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                   <span class="keyword">if</span>(data.data[<span class="number">0</span>])&#123;</span><br><span class="line">                       data.data = <span class="string">'手机号已注册！'</span></span><br><span class="line">                   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                       <span class="comment">//腾讯云的sdk封装，下面有具体写法</span></span><br><span class="line">                       sms.ssender(phone,romStr,(req,res,resData)=&gt;&#123;</span><br><span class="line">                           <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                               <span class="built_in">console</span>.log(<span class="string">"err: "</span>, err);</span><br><span class="line">                               data.data = <span class="string">"验证码发送失败！"</span></span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="built_in">console</span>.log(<span class="string">"request data: "</span>, res.req);</span><br><span class="line">                               <span class="built_in">console</span>.log(<span class="string">"response data: "</span>, resData);</span><br><span class="line">                               data.data = <span class="string">"验证码发送成功！"</span></span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;)</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);       </span><br><span class="line">               <span class="comment">// 释放连接  </span></span><br><span class="line">               connection.release();</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>腾讯云短信nodejs sdk的封装：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> QcloudSms = <span class="built_in">require</span>(<span class="string">"qcloudsms_js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短信应用SDK AppID</span></span><br><span class="line"><span class="keyword">var</span> appid = xxxxxxx;  <span class="comment">// SDK AppID是1400开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 短信应用SDK AppKey</span></span><br><span class="line"><span class="keyword">var</span> appkey = <span class="string">"xxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短信模板ID，需要在短信应用中申请</span></span><br><span class="line"><span class="keyword">var</span> templateId = <span class="number">7839</span>;  <span class="comment">// <span class="doctag">NOTE:</span> 这里的模板ID`7839`只是一个示例，真实的模板ID需要在短信控制台中申请</span></span><br><span class="line"><span class="comment">//templateId 7839 对应的内容是"您的验证码是: &#123;1&#125;"</span></span><br><span class="line"><span class="comment">// 签名</span></span><br><span class="line"><span class="keyword">var</span> smsSign = <span class="string">"XX"</span>;  <span class="comment">// <span class="doctag">NOTE:</span> 这里的签名只是示例，请使用真实的已申请的签名, 签名参数使用的是`签名内容`，而不是`签名ID`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化QcloudSms</span></span><br><span class="line"><span class="keyword">var</span> qcloudsms = QcloudSms(appid, appkey);</span><br><span class="line"><span class="keyword">var</span> ssender = qcloudsms.SmsSingleSender();</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * @params phoneNumbers [Array or String]</span></span><br><span class="line"><span class="comment">     * @params params [Array]</span></span><br><span class="line"><span class="comment">     * @params callback(req res resData)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ssender:<span class="function">(<span class="params">phoneNumbers,params,callback</span>) =&gt;</span> &#123;</span><br><span class="line">        ssender.sendWithParam(<span class="number">86</span>, phoneNumbers,templateId,params,smsSign, <span class="string">""</span>, <span class="string">""</span>, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><p>因为使用了postman做接口测试，总是走到了phone不存在这一步，纠结了很久最后发现response会set-Cookie，postman不是浏览器，不会在下次请求的时候携带上这个，所以测试的时候要自己手动设置一下Cookie。<br>这是response的connect.sid<br><img src="https://i.loli.net/2018/08/24/5b7f6a8aafa27.png" alt><br>在request设置Cookie:<br><img src="https://i.loli.net/2018/08/24/5b7f6b0969d0c.png" alt></p>
<p>如果各位大神还有别的办法，烦请指导。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-06-08</span><i class="fa fa-tag"></i><a class="tag" href="/tags/javascript/" title="javascript">javascript </a></div></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://chaoxuelei.github.io/2019/06/08/NodeJs-Express-短信验证完全实践/,Joshua-blog,NodeJs + Express 短信验证完全实践,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/06/08/使用VUE2-0做一个简单的分页，过程很详细/" title="使用VUE2.0做一个简单的分页，过程很详细">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/06/08/关于UX你必须要知道的一些事情/" title="关于UX你必须要知道的一些事情">下一篇</a></li></ul></div></div></div></div><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>